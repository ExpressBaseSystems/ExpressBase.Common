-- FUNCTION: public.eb_objects_first_commit(text, text, integer, integer, json, integer, text, text, text[], boolean)

-- DROP FUNCTION public.eb_objects_first_commit(text, text, integer, integer, json, integer, text, text, text[], boolean);

CREATE OR REPLACE FUNCTION public.eb_objects_first_commit(
	obj_namev text,
	obj_descv text,
	obj_typev integer,
	obj_cur_statusv integer,
	obj_jsonv json,
	commit_uidv integer,
	src_pid text,
	cur_pid text,
	relationsv text[],
	isversioned boolean)
    RETURNS text
    LANGUAGE 'plpgsql'
    COST 100
    VOLATILE 
    ROWS 0
AS $BODY$

DECLARE refidunique text; inserted_objid integer; inserted_obj_ver_id integer;refid_of_commit_version text;
BEGIN   
    INSERT INTO eb_objects 
        (obj_name, obj_desc, obj_type, obj_last_ver_id, obj_cur_status) 
    VALUES
        (obj_namev, obj_descv, obj_typev, 1, obj_cur_statusv) RETURNING id INTO inserted_objid;

    INSERT INTO eb_objects_ver
        (eb_objects_id, ver_num, obj_json, commit_uid, commit_ts) 
    VALUES
        (inserted_objid, 1, obj_jsonv, commit_uidv, NOW())RETURNING id INTO inserted_obj_ver_id;
            
	--source_pid-current_pid-object_type-objectid-object_ver_id 
    refidunique := CONCAT_WS('-', src_pid, cur_pid, obj_typev, inserted_objid, inserted_obj_ver_id); 
    refid_of_commit_version:=refidunique;                       
	UPDATE eb_objects_ver SET refid = refidunique WHERE id = inserted_obj_ver_id;
    
    INSERT INTO eb_objects_relations (dominant,dependant) VALUES (UNNEST(relationsv),refidunique);
    
    IF isversioned = TRUE THEN
		-- INSERT VER FOR SAVE -1
    	INSERT INTO eb_objects_ver
        	(eb_objects_id, ver_num, obj_json) 
    	VALUES
        	(inserted_objid, -1, obj_jsonv) RETURNING id INTO inserted_obj_ver_id;
            
		refidunique := CONCAT_WS('-', src_pid, cur_pid, obj_typev, inserted_objid, inserted_obj_ver_id);
                                  
		UPDATE eb_objects_ver SET refid = refidunique WHERE id = inserted_obj_ver_id;  
            
		INSERT INTO eb_objects_relations (dominant,dependant) VALUES (UNNEST(relationsv),refidunique);
    END IF;
	RETURN refid_of_commit_version;
END;

$BODY$;

ALTER FUNCTION public.eb_objects_first_commit(text, text, integer, integer, json, integer, text, text, text[], boolean)
    OWNER TO postgres;

